require 'json'

raw_data = {
  flute: {
    root: 'c4',
    partials: { 1=> 31, 2=> 39, 3=> 31, 4=> 40, 5=> 42, 6=> 26, 7=> 36, 8=> 36, 9=> 25, 10=> 25, 11=> 18, 12=> 26, 13=> 24, 14=> 19, 15=> 19, 16=> 18, 17=> 15, 18=> 12, 19=> 10, 20=> 12, 21=> 8, 22=> 6, 23=> 7, 24=> 5, 25=> 6, 26=> 3, 27 => 2, 28=> 6, 29=> 0, 30=> 2 } },

  piccolo: {
    root: 'c6',
    partials: { 1=> 55, 2=> 53, 3=> 44, 4=> 42, 5=> 29, 6=> 27, 7=> 20, 8=> 19, 9=> 13, 10=> 10, 11=> 3, 12=> 0 } },

  violin:
    { root: 'c4',
      partials: { 1=> 42, 1.5=>7, 2=> 47, 2.5=> 0, 3=> 38, 3.5=> 7, 4=> 28, 5=> 29, 6=> 41, 7=> 40, 8=> 38, 9=> 37, 10=> 25, 11=> 29, 12=> 31, 13=> 20, 14=> 26, 15=> 22, 16=> 21, 17=> 24, 18=> 19, 19=> 15, 20=> 19, 21=> 10, 22=> 7, 23=> 2, 24=> 10, 25=> 16, 26=> 10, 27 => 4, 28=> 4, 29=> 4, 30=> 4 } },

  viola:
    { root: 'c4',
      partials: { 1=> 33, 1.5=> 17,2=> 33, 2.3=> 5, 3=> 40, 3.5=> 7, 4=> 33, 4.5=> 6, 5=> 31, 5.4=> 8, 6=> 29, 7=> 36, 8=> 39, 9=> 27, 10=> 31, 11=> 26, 12=> 27, 13=> 19, 14=> 25, 15=> 18, 16=> 17, 17=> 16, 18=> 11, 19=> 21, 20=> 11, 21=> 11, 22=> 10, 23=> 6, 24=> 6, 25=> 6, 26=> 6, 27 => 6, 28=> 3, 29=> 2, 30=> 1 } },

  cello:
    { root: 'c4',
      partials: { 1=> 44, 1.3=> 5, 1.7=>0, 2=> 45, 2.3=> 1, 3=> 51, 3.4=> 3, 4=> 47, 4.4=> 4, 5=> 51, 6=> 49, 6.5=> 10, 7=> 39, 8=> 44, 9=> 34, 10=> 42, 11=> 34, 12=> 34, 13=> 38, 14=> 34, 15=> 31, 16=> 27, 17=> 22, 18=> 25, 19=> 19, 20=> 27, 21=> 25, 22=> 26, 23=> 30, 24=> 28, 25=> 25, 26=> 22, 27 => 21, 28=> 22, 29=> 23, 30=> 23 } },

  contrabass:
    { root: 'c3',
      partials: { 1=> 42, 1.5=>1,  2=> 40, 3=> 41, 4=> 38, 5=> 37, 6=> 36, 7=> 37, 8=> 28, 9=> 39, 10=> 35, 11=> 35, 12=> 36, 13=> 35, 14=> 24, 15=> 29, 16=> 31, 17=> 27, 18=> 25, 19=> 20, 20=> 23, 21=> 23, 22=> 21, 23=> 27, 24=> 16, 25=> 18, 26=> 20, 27 => 16, 28=> 17, 29=> 19, 30=> 19 } },

  clarinet:
    { root: 'c4',
      partials: { 1=> 48, 2=> 26, 3=> 54, 4=> 44, 5=> 41, 6=> 51, 7=> 40, 8=> 26, 9=> 37, 10=> 45, 11=> 42, 12=> 33, 13=> 31, 14=> 9, 15=> 21, 16=> 22, 17=> 19, 18=> 22, 19=> 17, 20=> 7, 21=> 2, 22=> 7, 23=> 0, 24=> 1, 25=> -5, 26=> 5, 27 => 3, 28=> 2, 29=> -7, 30=> -6 } },

  bass_clarinet:
    { root: 'c3',
      partials: { 1=>20, 2=> 13, 3=> 24, 4=> 7, 5=> 22, 6=> 3, 7=> 16, 8=> 10, 9=> 17, 10=> 13, 11=> 4, 12=> 17, 13=> 17, 14=> 32, 15=> 17, 16=> 22, 17=> 18, 18=> 8, 19=> 7, 20=> 5, 21=> 0, 22=> 6, 23=> 1, 24=> 7, 25=> 8, 26=> 6, 27 => 0, 28=> 10, 29=> 3, 30=> 5 } },

  oboe:
    { root: 'c4',
      partials: { 1=> 27, 2=> 30, 3=> 30, 4=> 39, 5=> 39, 6=> 38, 7=> 35, 8=> 32, 9=> 30, 10=> 34, 11=> 32, 12=> 36, 13=> 27, 14=> 25, 15=> 29, 16=> 22, 17=> 14, 18=> 13, 19=> 5, 20=> 2, 21=> 12, 22=> 11, 23=> 9, 24=> 12, 25=> 10, 26=> 7, 27 => 2, 28=> 5, 29=> 6, 30=> 0} },

  bassoon:
    { root: 'c4',
      partials: { 1=> 35, 2=> 52, 2.5=>5, 3=> 46, 3.5=> 7, 4=> 43, 5=> 45, 6=> 39, 7=> 17, 8=> 23, 9=> 16, 10=> 15, 11=> 20, 12=> 22, 13=> 28, 14=> 21, 15=> 22, 16=> 16, 17=> 18, 18=> 9, 19=> 10, 20=> 13, 21=> 8, 22=> 3, 23=> 9, 24=> 7, 25=> 9, 26=> 0, 27 => 11, 28=> 6, 29=> 4, 30=> 3} },

  english_horn:
    { root: 'c4',
      partials: { 1=> 27, 2=> 23, 3=> 39, 4=> 46, 5=> 44, 6=> 34, 6.5=> 9, 7=> 38, 8=> 34, 9=> 33, 10=> 24, 11=> 14, 12=> 15, 13=> 21, 14=> 20, 15=> 18, 16=> 16, 17=> 2, 18=> 9, 19=> 8, 20=> 13, 21=> 10, 22=> 9, 23=> 6, 24=> 10, 25=> 10, 26=> 4, 27 => 1, 28=> 2, 29=> 2, 30=> 0 } },

  french_horn:
    { root: 'c4',
      partials: { 1=> 53, 1.4=> 15, 1.6=> 14, 2=> 50, 2.4=> 20, 2.6=> 19, 3=> 50, 3.5=> 14, 4=> 51, 5=> 41, 6=> 42, 7=> 43, 8=> 46, 9=> 49, 10=> 41, 11=> 40, 12=> 36, 13=> 39, 14=> 34, 15=> 30, 16=> 34, 17=> 33, 18=> 22, 19=> 29, 20=> 19, 21=> 19, 22=> 23, 23=> 20, 24=> 11, 25=> 15, 26=> 12, 27 => 0, 28=> 7, 29=> 16, 30=> 13 } },

  trumpet:
    { root: 'c4',
      partials: { 1=> 39, 1.4=> 0, 2=> 42, 2.3=> 5, 2.4=>6, 2.8=> 8, 3=> 47, 3.4=> 13, 4=> 51, 5=> 52, 6=> 51, 7=> 50, 8=> 45, 9=> 46, 10=> 43, 11=> 39, 12=> 39, 13=> 31, 14=> 28, 15=> 28, 16=> 25, 17=> 26, 18=> 25, 19=> 19, 20=> 21, 21=> 22, 22=> 18, 23=> 14, 24=> 12, 25=> 11, 26=> 10, 27 => 9, 28=> 6, 29=> 0, 30=> 1 } },

  trombone:
    { root: 'c4',
      partials: { 1=> 63, 1.3=> 17, 1.5=>18, 1.7=>25, 2=> 70, 2.3=> 27, 2.5=> 30, 3=> 71, 4=> 69, 4.5=> 32, 5=> 69, 5.5=> 30, 6=> 68, 7=> 64, 8=> 61, 9=> 59, 10=> 54, 11=> 49, 12=> 47, 13=> 44, 14=> 41, 15=> 40, 16=> 35, 17=> 34, 18=> 32, 19=> 29, 20=> 25, 21=> 23, 22=> 21, 23=> 18, 24=> 15, 25=> 11, 26=> 7, 27 => 4, 28=> 0, 29=> 0, 30=> 0 } },

  contrabass_trombone:
    { root: 'c3',
      partials: { 1=> 44, 2=> 45, 3=> 50, 4=> 47, 5=> 46, 6=> 49, 7=> 48, 8=> 48, 9=> 44, 10=> 42, 11=> 40, 12=> 37, 13=> 35, 14=> 32, 15=> 29, 16=> 26, 17=> 23, 18=> 21, 19=> 20, 20=> 17, 21=> 19, 22=> 16, 23=> 12, 24=> 12, 25=> 10, 26=> 6, 27 => 4, 28=> 2, 29=> 0, 30=> 0 } },

  tuba:
    { root: 'c3',
      partials: { 1=>  54, 2=> 62, 3=> 61, 4=> 59, 5=> 53, 6=> 49, 7=> 45, 8=> 39, 9=> 44, 10=> 36, 11=> 28, 12=> 26, 13=> 27, 14=> 22, 15=> 15, 16=> 15, 17=> 17, 18=> 16, 19=> 16, 20=> 15, 21=> 11, 22=> 9, 23=> 8, 24=> 4, 25=> 5, 26=> 5, 27 => 2, 28=> 2, 29=> 2, 30=> 0 } },

  contrabass_tuba:
    { root: 'c2',
      partials: { 1=> 0, 2=> 14, 3=> 19, 4=> 22, 5=> 25, 6=> 24, 7=> 25, 8=> 27, 9=> 25, 10=> 24, 11=> 25, 12=> 25, 13=> 25, 14=> 24, 15=> 21, 16=> 22, 17=> 24, 18=> 23, 19=> 23, 20=> 17, 21=> 12, 22=> 14, 23=> 15, 24=> 14, 25=> 13, 26=> 12, 27 => 12, 28=> 12, 29=> 12, 30=> 11 } },

  harpsichord:
    { root: 'c4',
      partials: { 1=> 76, 1.4=> 41, 1.6=> 34, 2=> 72, 2.4=> 25, 3=> 71, 3.4=> 24, 3.6=> 23, 4=> 69, 4.4=> 7, 5=> 65, 5.6=> 0, 6=> 55, 6.6=> 5, 7=> 57, 7.6=> 6, 8=> 63, 8.6=> 10, 9=> 75, 10=> 55, 11=> 41, 12=> 63, 13=> 66, 14=> 60, 15=> 56, 16=> 43, 17=> 44, 18=> 52, 19=> 56, 20=> 52, 21=> 51, 22=> 35, 23=> 41, 24=> 40, 25=> 52, 26=> 48, 27 => 28, 28=> 26, 29=> 35, 30=> 30 } }

  #xxx:
  #  { root: '',
  #    partials: { 1=>  , 2=> , 3=> , 4=> , 5=> , 6=> , 7=> , 8=> , 9=> , 10=> , 11=> , 12=> , 13=> , 14=> , 15=> , 16=> , 17=> , 18=> , 19=> , 20=>, 21=> , 22=> , 23=> , 24=> , 25=> , 26=> , 27 => , 28=> , 29=> , 30=> } }

}

def normalize(timbre)
  max = timbre[:partials].values.max.to_f

  timbre.clone.tap do |_|
    _[:partials] = _[:partials].transform_values { |_| _ - max }
  end
end

normalized_data = raw_data.transform_values { |_| normalize(_) }

only_harmonics = normalized_data
      .transform_keys { |_| _.to_s.gsub('_', ' ') }
      .transform_values { |_| _.dig(:partials).select { |k,v| k.is_a?(Integer) }.values }

only_harmonics.transform_values! do |levels|
  levels + [-50] * (30 - levels.size)
end

only_harmonics[:harmonic] = (1..30).to_a

puts "harmonics = #{JSON.generate(only_harmonics,  array_nl: "", object_nl: "\n", indent: ' ', space_before: '', space: ' ')}"

